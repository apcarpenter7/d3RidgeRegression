<!DOCTYPE html>
<meta charset="utf-8">
<!-- <style>
#slider{
  width: 50px;
  margin:0 auto;
  align: center
}

  </style> -->

<svg width="1000" height="700">
</svg>

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v7.js"></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/seedrandom/2.3.10/seedrandom.min.js></script>
<script src="math.js" type="text/javascript"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">


<span id="slider_value"></span>
<!-- 0<input id="slider" class = "range" type="range" value="0" min="0" max="99" oninput="updateData()" onchange="rangeSlide(this.value)">100 -->
0<input id="slider" class = "range" type="range" value="0" min="0" max="99" oninput="updateData()" onmousemove="this.nextElementSibling.value = this.value">99
<output>0</output>

<!-- <span id="rangeValue">0</span>
<Input class="range" type="range" name "" value="0" min="0" max="1000" onChange="rangeSlide(this.value)" onmousemove="rangeSlide(this.value)" oninput="updateData()"></Input> -->

<script>



function makeArr(startValue, stopValue, cardinality) {
  var arr = [];
  var step = (stopValue - startValue) / (cardinality - 1);
  for (var i = 0; i < cardinality; i++) {
    arr.push(startValue + (step * i));
  }
  return arr;
}

function makeDataset(x_arr, y_arr) {
  var dataArr = []
  for (var i = 0; i < x_arr.length; i++) {
    dataArr.push([x_arr[i], y_arr[i]])

  }
  return dataArr
}

Math.seedrandom('Ridge Regression')

function boxMullerTransform() {
    const u1 = Math.random();
    const u2 = Math.random();
    
    const z0 = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
    const z1 = Math.sqrt(-2.0 * Math.log(u1)) * Math.sin(2.0 * Math.PI * u2);
    
    return { z0, z1 };
}

function getNormallyDistributedRandomNumber(mean, stddev) {
    const { z0, _ } = boxMullerTransform();
    
    return z0 * stddev + mean;
}

function createXmat(x) {
  mat = []
  for ( var i = 0; i < x.length; i ++) {
    xi = x[i]
    mat.push([xi ** 5, xi ** 4, xi ** 3, xi ** 2, xi, 1])

  }
  return math.matrix(mat)
}

function coefficients(x_mat, y_mat, lambda) {

  // OLS for Ridge
  var lambda = math.multiply(math.identity(6), lambda)
  var beta = math.multiply(math.multiply(math.inv(math.add(math.multiply(math.transpose(x_mat), x_mat), lambda)), math.transpose(x_mat)), y_mat)

  return beta
}

function predictRidge(x_mat, coefficients) {

  return math.multiply(x_mat, coefficients)

}

function linearRegression(x_mat, y_mat, lambda) {

  // add intercept
  // x_mat = math.matrix(makeDataset(x_mat._data, math.ones(500)._data))
  lambda = math.multiply(math.identity(6), lambda)

  // OLS
  beta = math.multiply(math.multiply(math.inv(math.add(math.multiply(math.transpose(x_mat), x_mat), lambda)), math.transpose(x_mat)), y_mat)
  y_hat = math.multiply(x_mat, beta)
  return y_hat

}

const X = makeArr(1, 5, 500)
const Y = X.map(function(x) {return (-0.5335 * x ** 5) +
  (9.0255 * x ** 4 )- 
  (57.136 * x ** 3) +
  (166.15 * x ** 2) -
  (215.18 * x) + 97.6 + getNormallyDistributedRandomNumber(0, 1)})
const dataset = makeDataset(X, Y)
//const Yhat = linearRegression(math.matrix(X), math.matrix(Y), 0)
const Yhat = linearRegression(createXmat(X), math.matrix(Y), 0)
//const regLine = makeDataset(X, Yhat._data)


var lambdas = makeArr(1, 100, 100)

var allData = []
var coefData = []
for (var i = 0; i < lambdas.length; i++) {

  // var yhat = linearRegression(createXmat(X), math.matrix(Y), lambdas[i])
  // var fitLine = makeDataset(X, yhat._data)
  var Xmat = createXmat(X)
  var coefs = coefficients(Xmat, math.matrix(Y), lambdas[i])
  coefData.push(coefs._data)
  var yhat = predictRidge(Xmat, coefs)
  var fitLine = makeDataset(X, yhat._data)
  allData.push(fitLine)
}


var svg = d3.select("svg"),
            margin = 200,
            width = svg.attr("width") - margin,
            height = svg.attr("height") - margin

var xScale = d3.scaleLinear().domain([d3.min(X), d3.max(X)]).range([0, width]),
             yScale = d3.scaleLinear().domain([d3.min(Y), d3.max(Y)]).range([height, 0]);

var g = svg.append("g").attr("transform", "translate(" + 100 + "," + 100 + ")");


svg.append('text')
.attr('x', width/2 + 100)
.attr('y', 50)
.attr('text-anchor', 'middle')
.style('font-family', 'Helvetica')
.style('font-size', 24)
.text('Ridge Regression');

// X label
svg.append('text')
.attr('x', width/2 + 100)
.attr('y', height - 15 + 150)
.attr('text-anchor', 'middle')
.style('font-family', 'Helvetica')
.style('font-size', 14)
.text('X');

// Y label
svg.append('text')
.attr('text-anchor', 'middle')
.attr('transform', 'translate(60,' + height + ')rotate(-90)')
.attr('dx', 200)
.style('font-family', 'Helvetica')
.style('font-size', 14)
.text('Y');




// Coefficients

var c = ['x^5 ', 'x^4 ', 'x^3 ', 'x^2 ','x ', ' ']
function mergeLists(l1, l2) {
  var out = []
  for (var i = 0; i < l1.length; i ++) {
    out.push([l1[i] , l2[i]].join(''))
  }
return out
}

svg.append('text')
.datum(coefData[0])
.attr('text-anchor', 'middle')
.attr('x', width/2 + 100)
.attr('y', height + 180)
.attr('text-anchor', 'middle')
.style('font-family', 'Helvetica')
.style('font-size', 14)
//.text('y = ' + d3.format(".3f")(coefData[0][0]) + 'x')
.text(function (d, i) {return "y = " +  mergeLists(d.map(d3.format(".3f")).map(String), c).join("+")})
// .append('tspan')
// .text('5')
// .style('font-size', 10)
// .attr("dy",-7)
.attr('class', 'coefficients');



g.append("g")
         .attr("transform", "translate(0," + height + ")")
         .call(d3.axisBottom(xScale));
        
g.append("g")
  .call(d3.axisLeft(yScale));

svg.append('g')
      .selectAll("dot")
      .data(dataset)
      .enter()
      .append("circle")
      .attr("cx", function (d) { return xScale(d[0]); } )
      .attr("cy", function (d) { return yScale(d[1]); } )
      .attr("r", 2.5)
      .attr("transform", "translate(" + 100 + "," + 100 + ")")
      .style("fill", "#FF2D00");
//console.log(regLine)
svg.append('path')
      .datum(allData[0])
      .attr("fill", "none")
      .attr("stroke", "#B02203")
      .attr("stroke-width", 2)
      .attr("d", d3.line()
        .x(function(d) { return xScale(d[0])})
        .y(function(d) { return yScale(d[1])}))
      .attr("transform", "translate(" + 100 + "," + 100 + ")")
      .attr("class", "RegressionLine")

function updateData() {
//get the slider value
let k = document.getElementById('slider').value;
d3.select('.RegressionLine')
      .datum(allData[k])
      .attr("fill", "none")
      .attr("stroke", "#B02203")
      .attr("stroke-width", 2)
      .attr("d", d3.line()
        .x(function(d) { return xScale(d[0])})
        .y(function(d) { return yScale(d[1])}))
      .attr("transform", "translate(" + 100 + "," + 100 + ")")

// d3.select('.coefficients')
// .attr('text-anchor', 'middle')
// .attr('x', width/2 + 100)
// .attr('y', height + 180)
// .attr('text-anchor', 'middle')
// .style('font-family', 'Helvetica')
// .style('font-size', 12)
// .text(`${Math.round(coefData[i][0], 3)}`)
// .attr('class', 'coefficients');

d3.select('.coefficients')
.datum(coefData[k])
.attr('text-anchor', 'middle')
.attr('x', width/2 + 100)
.attr('y', height + 180)
.attr('text-anchor', 'middle')
.style('font-family', 'Helvetica')
.style('font-size', 14)
.text(function (d) {return "y = " +  mergeLists(d.map(d3.format(".3f")).map(String), c).join("+")})
.attr('class', 'coefficients');
}

function rangeSlide(value) {
            document.getElementById('slider_value').innerHTML = value;
        }

</script>

<p>Ridge regression adds a penatly term <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">\lambda</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">λ</span></span></span></span> to perform L2 regularization on vanilla linear regression.</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>i</mi><mi>n</mi><mo stretchy="false">∥</mo><mi>y</mi><mo>−</mo><mi>X</mi><mi>β</mi><msubsup><mo stretchy="false">∥</mo><mn>2</mn><mn>2</mn></msubsup><mo>+</mo><mi>λ</mi><mo stretchy="false">∥</mo><mi>β</mi><msubsup><mo stretchy="false">∥</mo><mn>2</mn><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">min \lVert y - X \beta \rVert_2^2 + \lambda \lVert \beta \rVert_2^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">min</span><span class="mopen">∥</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">Xβ</span><span class="mclose"><span class="mclose">∥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4519em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2481em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal">λ</span><span class="mopen">∥</span><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="mclose"><span class="mclose">∥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4519em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2481em;"><span></span></span></span></span></span></span></span></span></span></p>
<p>The L2 pentalty term aims to shrink the coefficients as much as possible</p>
<p>The closed form of this equation follows as</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msup><mi>X</mi><mi>T</mi></msup><mi>X</mi><mo>+</mo><mi>λ</mi><mi>I</mi><msup><mo stretchy="false">)</mo><mrow><mo>−</mo><mn>1</mn></mrow></msup><msup><mi>X</mi><mi>T</mi></msup><mi>y</mi></mrow><annotation encoding="application/x-tex">(X^TX + \lambda I)^{-1} X^T y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em;"></span><span class="mord mathnormal">λ</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></p>

        <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>



 