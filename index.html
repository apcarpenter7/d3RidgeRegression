<!DOCTYPE html>
<meta charset="utf-8">


<svg width="800" height="500">
</svg>

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/seedrandom/2.3.10/seedrandom.min.js></script>
<script src="math.js" type="text/javascript"></script>
<input id="slider" type="range" value="0" min="0" max="100" oninput="updateData();">

<script>



function makeArr(startValue, stopValue, cardinality) {
  var arr = [];
  var step = (stopValue - startValue) / (cardinality - 1);
  for (var i = 0; i < cardinality; i++) {
    arr.push(startValue + (step * i));
  }
  return arr;
}

function makeDataset(x_arr, y_arr) {
  var dataArr = []
  for (var i = 0; i < x_arr.length; i++) {
    dataArr.push([x_arr[i], y_arr[i]])

  }
  return dataArr
}

Math.seedrandom('Ridge Regression')

function boxMullerTransform() {
    const u1 = Math.random();
    const u2 = Math.random();
    
    const z0 = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
    const z1 = Math.sqrt(-2.0 * Math.log(u1)) * Math.sin(2.0 * Math.PI * u2);
    
    return { z0, z1 };
}

function getNormallyDistributedRandomNumber(mean, stddev) {
    const { z0, _ } = boxMullerTransform();
    
    return z0 * stddev + mean;
}

function createXmat(x) {
  mat = []
  for ( var i = 0; i < x.length; i ++) {
    xi = x[i]
    mat.push([xi ** 5, xi ** 4, xi ** 3, xi ** 2, xi, 1])

  }
  return math.matrix(mat)
}

function linearRegression(x_mat, y_mat, lambda) {

  // add intercept
  // x_mat = math.matrix(makeDataset(x_mat._data, math.ones(500)._data))
  lambda = math.multiply(math.identity(6), lambda)

  // OLS
  beta = math.multiply(math.multiply(math.inv(math.add(math.multiply(math.transpose(x_mat), x_mat), lambda)), math.transpose(x_mat)), y_mat)
  y_hat = math.multiply(x_mat, beta)
  return y_hat

}

const X = makeArr(1, 5, 500)
const Y = X.map(function(x) {return (-0.5335 * x ** 5) +
  (9.0255 * x ** 4 )- 
  (57.136 * x ** 3) +
  (166.15 * x ** 2) -
  (215.18 * x) + 97.6 + getNormallyDistributedRandomNumber(0, 1)})
// const Y_true = X.map(function(x) {return (0.1932 * x ** 6) -
//   (4.187 * x ** 5) +
//   (36.473 * x ** 4 )- 
//   (161.6 * x ** 3) +
//   (377.52 * x ** 2) -
//   (429.7 * x) + 181.29})
const dataset = makeDataset(X, Y)
//const Yhat = linearRegression(math.matrix(X), math.matrix(Y), 0)
const Yhat = linearRegression(createXmat(X), math.matrix(Y), 0)
console.log(Yhat)
//const regLine = makeDataset(X, Yhat._data)


lambdas = makeArr(1, 100, 100)
console.log(lambdas)
allData = []
for (var i = 0; i < lambdas.length; i++) {
  console.log(lambdas[i])
  yhat = linearRegression(createXmat(X), math.matrix(Y), lambdas[i])
  console.log(yhat)
  fitLine = makeDataset(X, yhat._data)
  allData.push(fitLine)
}


var svg = d3.select("svg"),
            margin = 200,
            width = svg.attr("width") - margin,
            height = svg.attr("height") - margin

var xScale = d3.scaleLinear().domain([d3.min(X), d3.max(X)]).range([0, width]),
             yScale = d3.scaleLinear().domain([d3.min(Y), d3.max(Y)]).range([height, 0]);

var g = svg.append("g").attr("transform", "translate(" + 100 + "," + 100 + ")");

svg.append('text')
.attr('x', width/2 + 100)
.attr('y', 50)
.attr('text-anchor', 'middle')
.style('font-family', 'Helvetica')
.style('font-size', 24)
.text('Ridge Regression');

// X label
svg.append('text')
.attr('x', width/2 + 100)
.attr('y', height - 15 + 150)
.attr('text-anchor', 'middle')
.style('font-family', 'Helvetica')
.style('font-size', 12)
.text('X');

// Y label
svg.append('text')
.attr('text-anchor', 'middle')
.attr('transform', 'translate(60,' + height + ')rotate(-90)')
.style('font-family', 'Helvetica')
.style('font-size', 12)
.text('Y');


g.append("g")
         .attr("transform", "translate(0," + height + ")")
         .call(d3.axisBottom(xScale));
        
g.append("g")
  .call(d3.axisLeft(yScale));

svg.append('g')
      .selectAll("dot")
      .data(dataset)
      .enter()
      .append("circle")
      .attr("cx", function (d) { return xScale(d[0]); } )
      .attr("cy", function (d) { return yScale(d[1]); } )
      .attr("r", 2.5)
      .attr("transform", "translate(" + 100 + "," + 100 + ")")
      .style("fill", "#FF2D00");
//console.log(regLine)
svg.append('path')
      .datum(allData[0])
      .attr("fill", "none")
      .attr("stroke", "#B02203")
      .attr("stroke-width", 2)
      .attr("d", d3.line()
        .x(function(d) { return xScale(d[0])})
        .y(function(d) { return yScale(d[1])}))
      .attr("transform", "translate(" + 100 + "," + 100 + ")")
      .attr("class", "RegressionLine")


function updateData() {
//get the slider value
let i = document.getElementById('slider').value;
d3.select('.RegressionLine')
      .datum(allData[i])
      .attr("fill", "none")
      .attr("stroke", "#B02203")
      .attr("stroke-width", 2)
      .attr("d", d3.line()
        .x(function(d) { return xScale(d[0])})
        .y(function(d) { return yScale(d[1])}))
      .attr("transform", "translate(" + 100 + "," + 100 + ")")
}

</script>

<p>this is html in svg 1</p>
<p>this is html in svg 2</p>
<p>this is html in svg 3</p>
<p>this is html in svg 4</p>



 